<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content='width=device-width, initial-scale=1'>


    <link type="text/css" rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/4.6.1/firebase-ui-auth.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW"
        crossorigin="anonymous"></script>
</head>

<body>

    <h1>Mail OPENED</h1>



    <div class="modal fade" id="myModal" tabindex="-1">
        <div class="modal-dialog modal-sm modal-dialog-centered">
            <div class="modal-content">

                <div class='modal-body' id="firebaseui-auth-container"></div>
            </div>
        </div>
    </div>

    <ul class="nav nav-pills mb-3" id="pills-tab">
        <li class="nav-item">
            <a class="nav-link active" id="pills-start-tab" data-bs-toggle="pill" href="#pills-start">Getting
                Started</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="pills-track-tab" data-bs-toggle="pill" href="#pills-track">Your trackers</a>
        </li>
    </ul>
    <div class="tab-content container" id="pills-tabContent">
        <div class="tab-pane fade show active" id="pills-start">
            <button onclick="create_inv_img()">INVISIBLE TRACKER</button>
            <button onclick="activate_lnk()">ACTIVATE TRACKER</button>
        </div>
        <div class="tab-pane fade container" id="pills-track">
            <select onchange="links_select_change()" class="form-select" id="links_select">
                <option selected disabled>--SELECT TRACKER--</option>
            </select>
            <button id="deactivate_btn" onclick="deactivate_lnk()">DEACTIVATE TRACKER</button>
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>IP</th>
                        <th>User Agent</th>
                        <th>Time</th>
                    </tr>
                </thead>
                <tbody id="logs_table">

                </tbody>
            </table>
        </div>
    </div>




</body>

<!-- The core Firebase JS SDK is always required and must be listed first -->
<script src="https://www.gstatic.com/firebasejs/8.2.1/firebase-app.js"></script>

<!-- TODO: Add SDKs for Firebase products that you want to use
     https://firebase.google.com/docs/web/setup#available-libraries -->
<script src="https://www.gstatic.com/firebasejs/8.2.1/firebase-analytics.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.2.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/ui/4.6.1/firebase-ui-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.2.1/firebase-database.js"></script>

<script>
    // Your web app's Firebase configuration
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    var firebaseConfig = {
        apiKey: "AIzaSyDW_dWlZJiegsi4sCELl-byyhnd866RXzA",
        authDomain: "mail-opened.firebaseapp.com",
        projectId: "mail-opened",
        storageBucket: "mail-opened.appspot.com",
        messagingSenderId: "56856215322",
        appId: "1:56856215322:web:b712037d4c254d4f0c36a3",
        measurementId: "G-T51Z8BPC09"
    };
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    firebase.analytics();
</script>

<script>

    var links_key;
    var new_link_key;

    firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL).then(() => {

        var ui = new firebaseui.auth.AuthUI(firebase.auth());

        var uiConfig = {
            callbacks: {
                signInSuccessWithAuthResult: function (authResult, redirectUrl) {

                    if (authResult.additionalUserInfo.isNewUser) {
                        createNewUser(authResult.user.uid, authResult.user.email);
                    }
                    return false;
                },

            },
            // Will use popup for IDP Providers sign-in flow instead of the default, redirect.
            signInFlow: 'popup',
            signInOptions: [
                // Leave the lines as is for the providers you want to offer your users.
                {
                    provider: firebase.auth.EmailAuthProvider.PROVIDER_ID,
                    signInMethod: firebase.auth.EmailAuthProvider.EMAIL_LINK_SIGN_IN_METHOD,

                }
            ],

        };
        ui.start('#firebaseui-auth-container', uiConfig);


    })

    firebase.auth().onAuthStateChanged(async (user) => {
        var links = (await firebase.database().ref('users/' + user.uid + '/links').once("value")).val();
        var ih = `<option selected disabled>--SELECT TRACKER--</option>`;

        links_key = {};
        for (x in links) {
            links_key[links[x].track] = x;
            ih += `<option>${links[x].track}</option>`;
        }

        links_select.innerHTML = ih;
    })


    function createNewUser(uid, mail) {
        fetch("https://iflyrlquq5.execute-api.us-east-2.amazonaws.com/default/mail-opened-query", {
            method: 'POST',
            body: JSON.stringify({
                query: 'create',
                uid: uid,
                mail: mail
            })
        })
    }

    function create_inv_img() {
        if (firebase.auth().currentUser) {
            var track_name = prompt("Track Name ?");
            if (track_name) {
                var uid = firebase.auth().currentUser.uid;
                var link_ref = firebase.database().ref('users/' + uid + "/links");
                new_link_key = link_ref.push().key;
                link_ref.update({ [new_link_key + "/track"]: track_name });

                navigator.clipboard.write([
                    new ClipboardItem({
                        ['text/html']: new Blob([`<img src="https://xpl6mndw31.execute-api.us-east-2.amazonaws.com/default/gmail-read-receipt/?key=${new_link_key}&uid=${uid}">`], { type: 'text/html' })
                    })
                ])

                alert("Tracker copied to Clipboard")
            }
        } else {
            var myModal = new bootstrap.Modal(document.getElementById('myModal'));
            myModal.show();
            document.getElementById("firebaseui-auth-container").style.display = 'block';
            document.getElementsByClassName("firebaseui-id-secondary-link")[0].addEventListener('click', () => { myModal.hide() })

        }
    }


    function activate_lnk() {
        firebase.database().ref(`users/${firebase.auth().currentUser.uid}/links/${new_link_key}/active`).set(true);
    }

    function activate_lnk() {
        firebase.database().ref(`users/${firebase.auth().currentUser.uid}/links/${links_key[links_select.value]}/active`).set(false);
    }

    var prev_sel_val;

    async function links_select_change() {
        if(prev_sel_val)
            firebase.database().ref("users/" + firebase.auth().currentUser.uid + "/links/" + links_key[prev_sel_val] + "/logs").off("value");
        firebase.database().ref("users/" + firebase.auth().currentUser.uid + "/links/" + links_key[links_select.value] + "/logs").on("value", (snap) => {
            var v = snap.val();
            var ih = "";
            for (x in v) {
                ih += `<tr><td>${v[x]['ip']}</td><td>${v[x]['ua']}</td><td>${v[x]['dt']}</td></tr>`;
            }

            logs_table.innerHTML = ih;
        })


        var isActive = (await firebase.database().ref(`users/${firebase.auth().currentUser.uid}/links/${links_key[links_select.value]}/active`).once("value")).val();
        if(!isActive){
            deactivate_btn.disabled=true;
        }else{
            deactivate_btn.disabled=false;
        }

        prev_sel_val = links_select.value;
    }

</script>

</html>