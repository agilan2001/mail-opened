<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content='width=device-width, initial-scale=1'>
    <title>Mail Opened?</title>
    <link type="text/css" rel="stylesheet" href="style.css" />
    <link type="text/css" rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/4.6.1/firebase-ui-auth.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW"
        crossorigin="anonymous"></script>

</head>

<body>
    <div style="padding: 5px; background-color: paleturquoise; white-space: nowrap;">
        <img src="res/icon.png" style="width: 50px;">
        <span class="h1" style="font-size: 35px; vertical-align: middle; font-weight: bold;">Mail OPENED ??</span>
    </div>


    <div class="modal fade" id="myModal" tabindex="-1">
        <div class="modal-dialog modal-sm modal-dialog-centered">
            <div class="modal-content">
                <div class='modal-body' id="firebaseui-auth-container"></div>
            </div>
        </div>
    </div>

    <div style="position: sticky; top: 0; z-index: 1;">
        <ul style="background-color: greenyellow; font-weight: bold;" class="nav nav-pills" id="pills-tab">
            <li class="nav-item">
                <a class="nav-link active" id="pills-start-tab" data-bs-toggle="pill" href="#pills-start">Getting
                    Started</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="pills-track-tab" data-bs-toggle="pill" href="#pills-track"
                    onclick="trackers_tab_show()">My Trackers</a>
            </li>
        </ul>
        <div style="background-color: paleturquoise;padding: 10px; margin-bottom: 10px;">
            <a class="a" id="log_span" style="float: right; margin-right: 10px;" onclick="log_span_click()">Login</a>
            <span id="user_name_span">&nbsp;</span>
        </div>
    </div>
    <div class="tab-content container" id="pills-tabContent">
        <div class="tab-pane fade show active" id="pills-start">
            <h2 style="color:darkred">Want to check whether your Emails are being OPENED...</h2>
            <hr>
            <h5 style="color: red;font-weight: bold;">Simple, Unlimited and <span class="inv_span">INVISIBLE</span>
                Email-embedded trackers are here to aid you!!!</h5>
            <i>--- with Notifications support </i>
            <hr>
            <div class="container">
                <div class="row">
                    <div class="col-lg-8">


                        <div class="step_div">
                            <h6><span class="badge bg-danger">STEP 1</span> Compose Your Email.</h6>
                            <div class="step_cont">Start writing your Email in any of the Mail Apllications.</div>
                        </div>
                        <div class="step_div">
                            <h6><span class="badge bg-danger">STEP 2</span> Generate TRACKER</h6>
                            <div class="step_cont">Name your Tracker : <input id="tracker_name_txt" type="text"
                                    placeholder="e.g. Boss Email Tracker"><br>
                                <button class="btn btn-success" onclick="create_inv_img()" style="margin-top:10px"><span
                                        style="display: none;" id="create_inv_spinner"
                                        class="spinner-border spinner-border-sm">
                                    </span> GENERATE INVISIBLE TRACKER</button><br>
                                <div id="tracker_div">&nbsp;&nbsp;<img id="tracker_img">&nbsp;&nbsp;</div>&nbsp;
                            </div>
                        </div>
                        <div class="step_div">
                            <h6><span class="badge bg-danger">STEP 3</span> Copy TRACKER</h6>
                            <div class="step_cont"><button class="btn btn-primary" disabled="true" id="copy_tracker_btn"
                                    onclick="copy_tracker()">COPY INVISIBLE TRACKER</button><span id="copy_tick_span"
                                    style="color: green; display:none;">✔</span> <br>
                                Paste the INVISIBLE MAIL TRACKER into the body of your Email.<br>
                                Note: The Tracker becomes INVISIBLE after Activation (next step)
                            </div>
                        </div>

                        <div class="step_div">
                            <h6><span class="badge bg-danger">STEP 4</span> Activate TRACKER</h6>
                            <div class="step_cont">Send your Email. Goto <a class="a"
                                    onclick="document.getElementById('pills-track-tab').click()"
                                    style="cursor: pointer;">My
                                    Trackers</a> section and activate the INVISIBLE MAIL TRACKER.<br>
                                That's it...
                                Once you activate the TRACKER, your mail views are automatically logged.<br>
                            </div>
                        </div>
                        <i>CAUTION: After activation, all views to the email are logged (including the sender's).</i><br><br>
                    </div>
                    <div class="col-lg-4">
                        <h5 style="text-decoration: underline; color: blue; text-align: center; font-weight: bold;">50
                            sec USAGE DEMO Video</h5>
                        <video preload="metadata" controls>
                            <source src="res/demo-video.mp4" type="video/mp4">
                            Your browser does not support the video tag.
                        </video>
                    </div>
                </div>
            </div>

            <br><br><br><br>
        </div>
        <div class="tab-pane fade container" id="pills-track">
            <select onchange="links_select_change()" class="form-select" id="links_select">
                <option selected disabled>--SELECT TRACKER--</option>
            </select>
            <div class="container">
                <div class="row">
                    <div class="col-lg-6">

                        <div class="notif_options_div">
                            How do you want us to notify you when your mail is opened ?<br>
                            <div class="form-check">
                                <input class="form-check-input" onchange="email_notif_check()" type="checkbox"
                                    id="email_check">
                                <label class="form-check-label" for="email_check">
                                    Send an Email
                                </label>
                            </div>

                            <div class="form-check">
                                <input class="form-check-input" onchange="browser_notif_check()" type="checkbox"
                                    id="notif_check">
                                <label class="form-check-label" for="notif_check">
                                    Send Browser Notification
                                </label>
                            </div>
                        </div>

                        <button class="btn btn-success" id="toggle_activate_btn" style="display: block;margin: auto;"
                            onclick="toggle_activate_lnk()">ACTIVATE TRACKER</button><br>
                    </div>
                    <div class="col-lg-6">
                        <table id="logs_cont_table" class="table table-hover">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th style="width: 65vw; max-width: 300px;">Time</th>
                                </tr>
                            </thead>
                            <tbody id="logs_table">
                                <tr>
                                    <td></td>
                                    <td>Nothing to show</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>

    </div>




</body>

<!-- The core Firebase JS SDK is always required and must be listed first -->
<script src="https://www.gstatic.com/firebasejs/8.2.1/firebase-app.js"></script>

<!-- TODO: Add SDKs for Firebase products that you want to use
     https://firebase.google.com/docs/web/setup#available-libraries -->
<script src="https://www.gstatic.com/firebasejs/8.2.1/firebase-analytics.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.2.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/ui/4.6.1/firebase-ui-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.2.1/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.2.1/firebase-messaging.js"></script>

<script>
    // Your web app's Firebase configuration
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    var firebaseConfig = {
        apiKey: "AIzaSyDW_dWlZJiegsi4sCELl-byyhnd866RXzA",
        authDomain: "mail-opened.firebaseapp.com",
        projectId: "mail-opened",
        storageBucket: "mail-opened.appspot.com",
        messagingSenderId: "56856215322",
        appId: "1:56856215322:web:b712037d4c254d4f0c36a3",
        measurementId: "G-T51Z8BPC09"
    };
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    firebase.analytics();
</script>

<script>

    var tracks_ar;
    var new_link_key;

    const messaging = firebase.messaging();

    navigator.serviceWorker.register('firebase-messaging-sw.js', {
        scope: '.'
    });

    firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL).then(() => {

        var ui = new firebaseui.auth.AuthUI(firebase.auth());

        var uiConfig = {
            callbacks: {
                signInSuccessWithAuthResult: function (authResult, redirectUrl) {

                    if (authResult.additionalUserInfo.isNewUser) {
                        createNewUser(authResult.user.uid, authResult.user.email);
                    }
                    return false;
                },

            },
            // Will use popup for IDP Providers sign-in flow instead of the default, redirect.
            signInFlow: 'popup',
            signInOptions: [
                // Leave the lines as is for the providers you want to offer your users.
                {
                    provider: firebase.auth.EmailAuthProvider.PROVIDER_ID,
                    signInMethod: firebase.auth.EmailAuthProvider.EMAIL_LINK_SIGN_IN_METHOD,

                }
            ],

        };
        ui.start('#firebaseui-auth-container', uiConfig);


    })

    firebase.auth().onAuthStateChanged((user) => {
        if (user) {
            update_sel(user);
            user_name_span.innerHTML = "Signed in as <i><b>" + user.email.split("@")[0] + "</b></i>";
            log_span.innerHTML = "Logout"
        } else {
            user_name_span.innerHTML = "&nbsp;";
            log_span.innerHTML = "Login"
        }
    });

    function log_span_click() {
        if (firebase.auth().currentUser) {
            firebase.auth().signOut();
            user_name_span.innerHTML = "&nbsp;";
            log_span.innerHTML = "Login"
        } else {
            show_sign_in();
        }
    }

    async function update_sel(user) {
        if (user) {
            var tracks_ref = (await firebase.database().ref('users/' + user.uid + '/info/tracks').once("value")).val();
            var ih = "";


            tracks_ar = [];
            for (x in tracks_ref) {
                tracks_ar.push(tracks_ref[x])
                ih = `<option>${tracks_ref[x]}</option>` + ih;
            }

            ih = `<option selected disabled>--SELECT TRACKER--</option>` + ih;

            links_select.innerHTML = ih;
        }
    }

    function trackers_tab_show() {
        var user = firebase.auth().currentUser;
        if (!user) {
            show_sign_in();
        } else {
            update_sel(user);
        }
    }


    function createNewUser(uid, mail) {
        fetch("https://iflyrlquq5.execute-api.us-east-2.amazonaws.com/default/mail-opened-query", {
            method: 'POST',
            body: JSON.stringify({
                query: 'create',
                uid: uid,
                mail: mail
            })
        })
    }

    async function create_inv_img() {
        create_inv_spinner.style.display = "inline-block";
        copy_tick_span.style.display = "none";
        if (firebase.auth().currentUser) {
            var track_name = tracker_name_txt.value;
            if (!track_name) {
                track_name = "TRACKER: " + new Date().toLocaleDateString("en-IN");
                tracker_name_txt.value = track_name;
            }
            var uid = firebase.auth().currentUser.uid;

            var cur_cnt;
            await firebase.database().ref('users/' + uid + "/info/cnt").transaction((cnt) => { cur_cnt = cnt; return cnt + 1; });


            new_link_key = "l" + (cur_cnt + 1);

            var link_ref = firebase.database().ref('users/' + uid + "/links");
            link_ref.update({
                [new_link_key + "/conf/track"]: track_name,
                [new_link_key + "/conf/active"]: false,
                [new_link_key + "/conf/s_ma"]: false,
                [new_link_key + "/conf/s_no"]: false,
                [new_link_key + "/conf/doc"]: Date.now(),
            });

            tracker_img = document.getElementById("tracker_img");

            tracker_img.onload = () => {
                copy_tracker_btn.disabled = false;
                create_inv_spinner.style.display = "none";

            }
            tracker_img.src = `https://xpl6mndw31.execute-api.us-east-2.amazonaws.com/default/gmail-read-receipt/?key=${new_link_key}&uid=${uid}`


            firebase.database().ref('users/' + uid + "/info/tracks").push(track_name);

            // navigator.clipboard.write([
            //     new ClipboardItem({
            //         ['text/html']: new Blob([`<img src="https://xpl6mndw31.execute-api.us-east-2.amazonaws.com/default/gmail-read-receipt/?key=${new_link_key}&uid=${uid}">`], { type: 'text/html' })
            //     })
            // ])





        } else {
            show_sign_in();

        }
    }

    function show_sign_in() {
        var myModal = new bootstrap.Modal(document.getElementById('myModal'));
        myModal.show();
        document.getElementById("firebaseui-auth-container").style.display = 'block';
        document.getElementsByClassName("firebaseui-id-secondary-link")[0].addEventListener('click', () => { myModal.hide() })
    }

    function copy_tracker() {

        var selection = window.getSelection()
        selection.removeAllRanges();

        var range = document.createRange();
        range.selectNode(document.getElementById("tracker_div"))
        selection.addRange(range);
        var j = document.execCommand("copy")
        copy_tick_span.style.display = "inline";

        //selection.removeAllRanges();


    }


    async function toggle_activate_lnk() {
        var cur;
        await firebase.database().ref(`users/${firebase.auth().currentUser.uid}/links/${"l" + (tracks_ar.indexOf(links_select.value) + 1)}/conf/active`).transaction(val => { cur = !val; return cur; });
        if (!cur) {
            toggle_activate_btn.innerHTML = "ACTIVATE TRACKER";
            toggle_activate_btn.classList.remove("btn-danger");
            toggle_activate_btn.classList.add("btn-success");
        } else {
            toggle_activate_btn.innerHTML = "DEACTIVATE TRACKER";
            toggle_activate_btn.classList.remove("btn-success");
            toggle_activate_btn.classList.add("btn-danger");
        }
    }

    var prev_sel_val;

    async function links_select_change() {
        if (prev_sel_val)
            firebase.database().ref("users/" + firebase.auth().currentUser.uid + "/links/" + "l" + (tracks_ar.indexOf(prev_sel_val) + 1) + "/logs").off("value");
        firebase.database().ref("users/" + firebase.auth().currentUser.uid + "/links/" + "l" + (tracks_ar.indexOf(links_select.value) + 1) + "/logs").on("value", (snap) => {

            var v = snap.val();

            var ih = "";
            var cnt = 1;
            for (x in v) {
                ih = `<tr><td>${cnt}</td><td>${new Date(v[x]['dt']).toLocaleString('en-IN')}</td></tr>` + ih;
                cnt++;
            }

            logs_table.innerHTML = ih || `<tr><td></td><td>Nothing to show</td></tr>`;
        })

        var conf = (await firebase.database().ref(`users/${firebase.auth().currentUser.uid}/links/${"l" + (tracks_ar.indexOf(links_select.value) + 1)}/conf`).once("value")).val();

        var isActive = conf.active;
        if (!isActive) {
            toggle_activate_btn.innerHTML = "ACTIVATE TRACKER";
            toggle_activate_btn.classList.remove("btn-danger");
            toggle_activate_btn.classList.add("btn-success");
        } else {
            toggle_activate_btn.innerHTML = "DEACTIVATE TRACKER";
            toggle_activate_btn.classList.remove("btn-success");
            toggle_activate_btn.classList.add("btn-danger");
        }

        email_check.checked = conf.s_ma;

        notif_check.checked = conf.s_no;

        prev_sel_val = links_select.value;
    }

    function email_notif_check() {
        firebase.database().ref(`users/${firebase.auth().currentUser.uid}/links/${"l" + (tracks_ar.indexOf(links_select.value) + 1)}/conf/s_ma`).set(email_check.checked);
    }

    function browser_notif_check() {
        if (notif_check.checked) {
            messaging.getToken()
                .then(function (token) {
                    firebase.database().ref(`users/${firebase.auth().currentUser.uid}/info/fcm`).set(token);
                })

        }
        firebase.database().ref(`users/${firebase.auth().currentUser.uid}/links/${"l" + (tracks_ar.indexOf(links_select.value) + 1)}/conf/s_no`).set(notif_check.checked);


    }


    messaging.onMessage(function (payload) {
        console.log(payload)
        var notif_info = JSON.parse(payload.data.notification);
        var title = "Mail-Opened ⏰";
        var options = {
            body: notif_info.body + ": Your Mail is being viewed...",
            icon: "https://mail-opened.web.app/res/icon.png",
            actions: [
                { action: 'b', title: '👍DONE' },
                { action: 'a', title: 'Mail-Opened' }
            ]
        }
        navigator.serviceWorker.ready.then(function (registration) {
            registration.showNotification(title, options);
        });

    });


</script>

</html>